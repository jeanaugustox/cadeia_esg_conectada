import json
import os

ARQUIVO_JSON = "data/certificados.json"

certificados_registrados = []

def carregar_dados_do_arquivo():
    print(f"Verificando se o arquivo {ARQUIVO_JSON} existe...")

    if not os.path.exists(ARQUIVO_JSON):
        print("Arquivo n√£o encontrado. Come√ßando lista do zero.")
        return

    try:
        with open(ARQUIVO_JSON, "r", encoding="utf-8") as arquivo:
            dados = arquivo.read().strip()
            if not dados:
                print("Arquivo encontrado, mas est√° vazio. Come√ßando do zero.")
                return

            conteudo = json.loads(dados)

            if not isinstance(conteudo, list):
                print("Formato inesperado no JSON (esperado: lista). Ignorando conte√∫do.")
                return

            certificados_registrados.clear()
            certificados_registrados.extend(conteudo)
            print(f"Dados carregados! Temos {len(certificados_registrados)} certificados.")

    except json.JSONDecodeError:
        print(f"Erro: O arquivo {ARQUIVO_JSON} est√° corrompido ou mal formatado. Come√ßando do zero.")
    except Exception as e:
        print(f"Ocorreu um erro ao ler o arquivo: {e}")

def salvar_dados_no_arquivo():
    try:
        pasta = os.path.dirname(ARQUIVO_JSON)
        if pasta:
            os.makedirs(pasta, exist_ok=True)

        with open(ARQUIVO_JSON, "w", encoding="utf-8") as arquivo:
            json.dump(certificados_registrados, arquivo, indent=4, ensure_ascii=False)

        print(f"Lista salva no arquivo {ARQUIVO_JSON}!")
        return True

    except Exception as e:
        print(f"Ocorreu um erro ao salvar o arquivo: {e}")
        return False

def registrar_novo_certificado():
    print("\nPreencha abaixo os requisitos para enviar a sua certifica√ß√£o:")

    empresa = input("Digite o nome da Empresa: ").strip().title()
    certificado = input("Digite o nome do seu certificado ESG: ").strip().title()
    categoria = input("Digite a categoria do seu certificado: ").strip().title()
    emitido = input("Digite onde foi emitido (Fonte oficial): ").strip()
    validade = input("Digite a data de validade (ex: DD/MM/AAAA): ").strip()
    emissao = input("Digite a data de emiss√£o (ex: DD/MM/AAAA): ").strip()

    print(
        f"\nDe acordo com as informa√ß√µes fornecidas:\n"
        f"Empresa: {empresa}\n"
        f"Certificado: {certificado}\n"
        f"Categoria: {categoria}\n"
        f"Emitido por: {emitido}\n"
        f"Emiss√£o em: {emissao}\n"
        f"V√°lido at√©: {validade}"
    )
    print("Obrigado por preencher os dados do seu certificado!")

    confirmacao = input("Voc√™ confirma a conformidade e validade das informa√ß√µes? (S/N): ").lower().strip()
    if confirmacao != "s":
        print("‚ùå Opera√ß√£o cancelada. Por favor revise os dados.")
        return

    observacao_detalhe = "Nenhuma"
    observacao_pergunta = input("Deseja destacar alguma observa√ß√£o? (S/N): ").lower().strip()
    if observacao_pergunta == "s":
        observacao_detalhe = input("Digite a sua observa√ß√£o: ").strip()
        print("Sua observa√ß√£o foi registrada com sucesso!")
    else:
        print("Nenhuma observa√ß√£o registrada.")

    novo_registro = {
        "empresa": empresa,
        "certificado": certificado,
        "categoria": categoria,
        "emitido": emitido,
        "validade": validade,
        "emissao": emissao,
        "observacao": observacao_detalhe
    }

    certificados_registrados.append(novo_registro)

    if salvar_dados_no_arquivo(): 
        print("‚úÖ Certificado registrado e salvo no arquivo!")
    else:
        print("‚ùå Falha ao salvar o certificado no arquivo.")

def ranking_empresas():
    from collections import Counter

    print("\n" + "=" * 10 + " Ranking Total de Certificados " + "=" * 10)

    if not certificados_registrados:
        print("Nenhum certificado registrado ainda.")
        return

    lista_empresas = [cert.get("empresa") for cert in certificados_registrados if cert.get("empresa")]
    if not lista_empresas:
        print("Nenhuma empresa encontrada nos certificados registrados.")
        return

    ranking = Counter(lista_empresas)
    print(f"{'Pos.':<5} | {'Empresa':<30} | {'Qtd. Certificados':<20}")
    print("-" * 57)
    for i, (empresa, contagem) in enumerate(ranking.most_common(), 1):
        print(f"{i:<5} | {empresa:<30} | {contagem:<20}")

def menu_certificados():
    while True:
        print("\n" + "=" * 60)
        print("üìã M√≥dulo de Certificados")
        print("=" * 60)
        print("1. Registrar Novo Certificado")
        print("2. Ver Ranking de Empresas (Total de Certificados)")
        print("3. Voltar ao Menu Principal")
        print("-" * 60)

        escolha = input("Escolha uma op√ß√£o (1-3): ").strip()

        if escolha == "1":
            registrar_novo_certificado()
            input("\nPressione Enter para continuar...")
        elif escolha == "2":
            ranking_empresas()
            input("\nPressione Enter para continuar...")
        elif escolha == "3":
            print("Retornando ao menu principal...")
            break
        else:
            print("‚ùå Op√ß√£o inv√°lida. Por favor, escolha de 1 a 3.")
            input("\nPressione Enter para continuar...") 
 
  carregar_dados_do_arquivo()

carregar_dados_do_arquivo()
